#!/bin/bash
# addsshbot: versi non-interaktif untuk API Bot + Telegram notif

Login=$1
Pass=$2
iplimit=$3
masaaktif=$4

if [[ -z "$Login" || -z "$Pass" || -z "$iplimit" || -z "$masaaktif" ]]; then
  echo "Usage: $0 <username> <password> <iplimit> <expired_days>"
  exit 1
fi

# --- Info Server ---
IP=$(curl -s ipv4.icanhazip.com)
domain=$(cat /etc/xray/domain 2>/dev/null || echo "$IP")
hariini=$(date +"%Y-%m-%d")
expe=$(date -d "$masaaktif days" +"%Y-%m-%d")

# --- Buat direktori ---
sudo mkdir -p /etc/kyt/limit/ssh/ip
sudo mkdir -p /etc/ssh

# --- Simpan Limit IP ---
echo "$iplimit" | sudo tee /etc/kyt/limit/ssh/ip/$Login >/dev/null

# --- Buat User SSH ---
sudo /usr/sbin/useradd -e "$expe" -s /bin/false -M $Login 2>/dev/null
echo -e "$Pass\n$Pass\n" | sudo passwd $Login &>/dev/null

# --- Simpan ke database ---
sudo sed -i "/\b${Login}\b/d" /etc/ssh/.ssh.db
echo "#ssh# ${Login} ${Pass} 0 ${iplimit} ${expe}" | sudo tee -a /etc/ssh/.ssh.db >/dev/null

# --- Notifikasi Telegram ke Admin ---
CHATID=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 2)
URL="https://api.telegram.org/bot$KEY/sendMessage"

TEXT="
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
   Create SSH Success
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
 Terimakasih telah berlangganan
 di store kami..!!
 Harap gunakan dengan bijak
 Happy surfing..!!
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
<code> âœ¦ Hostname :</code> <code>$domain</code>
<code> âœ¦ Username :</code> <code>$Login</code>
<code> âœ¦ Password :</code> <code>$Pass</code>
<code> âœ¦ Limit IP :</code> <code>$iplimit User</code>
<code> âœ¦ Port : 80,443,22</code>
<code> âœ¦ SSH CUSTOM :</code>
<code>$domain:80@$Login:$Pass</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
<code> âœ¦ Expired : $expe</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"

if [[ -n "$CHATID" && -n "$KEY" ]]; then
  curl -s --max-time 10 \
    -d "chat_id=$CHATID&disable_web_page_preview=1&text=$TEXT&parse_mode=html" \
    $URL >/dev/null
fi

# --- Notifikasi Transaksi ke Channel ---
BOT_TOKEN_TRX="8220003675:AAH3Kc8DpW-pklkQZ3FJ7Eei19lfUvj7ofU"
CHAT_ID_TRX="@Free_Config01"   # channel username atau chat_id
TRX_ID=$(date +%s%N | md5sum | head -c 12)

TRX_MSG="SSH CREATED SUCCESS
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
âœ¦ CITY : $(curl -s ipinfo.io/city )
âœ¦ ISP : $(curl -s ipinfo.io/org | cut -d ' ' -f 2-10 )
âœ¦ DETAIL : trx SSH
âœ¦ USER  : ${Login}
âœ¦ LIMIT IP : ${iplimit} PENGGUNA
âœ¦ BERLAKU : ${masaaktif} HARI
âœ¦ EXPIRED : Tgl ${expe}
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
#TRX ${TRX_ID}"

curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN_TRX}/sendMessage" \
     -d "chat_id=${CHAT_ID_TRX}" \
     -d "text=${TRX_MSG}" >/dev/null

echo "âœ… addsshbot: Notifikasi transaksi terkirim. TRX=${TRX_ID} (channel=${CHAT_ID_TRX})"

# --- Output ke WhatsApp (2 pesan) ---
echo "===OUTPUT1==="
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo   "ğŸ“¡ ISP : $(curl -s ipinfo.io/org | cut -d ' ' -f 2-10 )"
echo   "ğŸŒ Host  : $domain"
echo   "ğŸ‘¤ User : $Login"
echo   "ğŸ”‘ Pass : $Pass"
echo   "ğŸ”— Port     : 80, 443, 22"
echo   "ğŸ­ Limit IP : $iplimit"
echo   "ğŸ“… Dibuat   : $hariini"
echo   "â³ Expired  : $expe"
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "===OUTPUT2==="
echo "${domain}:80@${Login}:${Pass}"

