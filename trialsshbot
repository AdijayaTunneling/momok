#!/bin/bash
# trialsshbot â€” Non-interaktif trial SSH untuk bot

set -euo pipefail

# Konfigurasi Telegram (opsional, jika /etc/bot/.bot.db tersedia)
CHATID="$(grep -E "^#bot# " "/etc/bot/.bot.db" 2>/dev/null | cut -d ' ' -f 3 || true)"
KEY="$(grep -E "^#bot# " "/etc/bot/.bot.db"  2>/dev/null | cut -d ' ' -f 2 || true)"
TIME="10"
URL="https://api.telegram.org/bot${KEY}/sendMessage"

# Konfigurasi server
domain="$(cat /etc/xray/domain)"
IP="$(curl -sS ipv4.icanhazip.com)"
rand=$(shuf -i 1000-9999 -n 1)
Login="${LOGIN_OVERRIDE:-Trial-${rand}}"
Pass="1"
minutes="${MINUTES:-30}"   # durasi trial runtime (hapus user setelah X menit)
masaaktif="${DAYS:-1}"     # expired account 1 hari (di DB system)

# Buat user SSH
useradd -e "$(date -d "${masaaktif} days" +"%Y-%m-%d")" -s /bin/false -M "$Login"
echo -e "${Pass}\n${Pass}\n" | passwd "$Login" &> /dev/null || true

# Catat ke DB internal jika dipakai
mkdir -p /etc/ssh
if ! grep -qw "$Login" /etc/ssh/.ssh.db 2>/dev/null; then
  echo "### ${Login} " >> /etc/ssh/.ssh.db
fi

# Tulis file info untuk klien
cat > "/var/www/html/ssh-${Login}.txt" <<-END
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
Format SSH OVPN Account
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
Username         : ${Login}
Password         : ${Pass}
Berakhir (runtime): ${minutes} Menit
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
IP               : ${IP}
Host             : ${domain}
Port OpenSSH     : 22
Port Dropbear    : 443, 109, 143
Port SSH UDP     : 1-65535
Port SSH WS      : 80, 8080, 8081-9999
Port SSH SSL WS  : 443
Port SSL/TLS     : 400-900
OVPN Download    : https://${domain}:81/
â—‡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—‡
END

# Jadwalkan penghapusan user setelah runtime trial
echo "userdel -f '${Login}'" | at now + ${minutes} minutes &> /dev/null || true

# Cetak output untuk agent.php
echo "===OUTPUT1==="
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "   âœ¦ Trial SSH Success âœ¦"
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "ğŸ“¡ Hostname : ${domain}"
echo "ğŸ‘¤ Username : ${Login}"
echo "ğŸ”‘ Password : ${Pass}"
echo "ğŸŒ IPServer : ${IP}"
echo "â³ Runtime  : ${minutes} Menit"
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "ğŸ”— TLS  : ${domain}:443@${Login}:${Pass}"
echo "ğŸ”— nTLS : ${domain}:80@${Login}:${Pass}"
echo "ğŸ”— UDP  : ${domain}:1-65535@${Login}:${Pass}"
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "ğŸ“„ Info lengkap: https://${domain}:81/ssh-${Login}.txt"
echo "âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª"
echo "===OUTPUT2==="
echo "${domain}:443@${Login}:${Pass}"

# Notifikasi Telegram (jika KEY/CHATID tersedia)
if [[ -n "${KEY}" && -n "${CHATID}" ]]; then
  TEXT=$(
    cat <<MSG
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
    âœ¦Trial SSH Successâœ¦
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
<code>âœ¦Hostname   :</code> <code>${domain}</code>
<code>âœ¦Username   :</code> <code>${Login}</code>
<code>âœ¦Password   :</code> <code>${Pass}</code>
<code>âœ¦IPServer   :</code> <code>${IP}</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
âœ¦<code>Expired ${minutes} Menit (runtime)</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
<code>âœ¦TLS</code> <code>${domain}:443@${Login}:${Pass}</code>
<code>âœ¦nTLS</code> <code>${domain}:80@${Login}:${Pass}</code>
<code>âœ¦UDP</code> <code>${domain}:1-65535@${Login}:${Pass}</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
âœ¦<code>https://${domain}:81/ssh-${Login}.txt</code>
âšªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•âšª
MSG
  )
  curl -s --max-time "${TIME}" -d "chat_id=${CHATID}&disable_web_page_preview=1&text=${TEXT}&parse_mode=html" "${URL}" >/dev/null || true
fi

exit 0

